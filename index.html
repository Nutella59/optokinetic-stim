<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Stimulation Optocinétique VR Sphérique</title>
  <style>
    body {
      margin: 0;
      background-color: black;
      overflow: hidden;
      color: white;
      font-family: sans-serif;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      background: rgba(0,0,0,0.6);
      padding: 10px;
      border-radius: 8px;
    }
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      display: block;
    }
    label {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div id="controls">
    <label>Colonnes: <input type="number" id="cols" value="10" min="1" /></label>
    <label>Lignes: <input type="number" id="rows" value="6" min="1" /></label>
    <label>Direction:
      <select id="direction">
        <option value="right">Droite ↔</option>
        <option value="left">Gauche ↔</option>
        <option value="up">Haut ↕</option>
        <option value="down">Bas ↕</option>
      </select>
    </label>
    <label>Vitesse: <input type="number" id="speed" value="2" step="0.5" min="0.1" /></label>
    <label>Inversion (s): <input type="number" id="invertTime" value="15" min="1" /></label>
    <label><input type="checkbox" id="vrMode" /> Mode VR</label>
    <label><input type="checkbox" id="sphereMode" /> Effet sphérique</label>
    <button onclick="startAnimation()">Lancer</button>
    <button onclick="togglePause()">⏸ Pause / ▶️ Reprendre</button>
  </div>

  <canvas id="canvas"></canvas>
  <canvas id="maskCanvas"></canvas>

  <script>
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const maskCanvas = document.getElementById("maskCanvas");
    const maskCtx = maskCanvas.getContext("2d");

    let points = [], isPaused = false;
    let cols = 10, rows = 6, direction = "right", baseDirection = "right";
    let speed = 2, invertInterval = 15000, lastInvertTime = Date.now();
    let vrEnabled = false, sphereEnabled = false;

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      maskCanvas.width = window.innerWidth;
      maskCanvas.height = window.innerHeight;
      drawMask();
    }

    function drawMask() {
      maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
      if (!vrEnabled) return;

      const w = maskCanvas.width / 2;
      const h = maskCanvas.height;
      maskCtx.fillStyle = "black";
      maskCtx.fillRect(0, 0, maskCanvas.width, maskCanvas.height);

      maskCtx.globalCompositeOperation = "destination-out";
      [0, w].forEach(x => {
        maskCtx.beginPath();
        maskCtx.arc(x + w / 2, h / 2, Math.min(w, h) / 2.1, 0, 2 * Math.PI);
        maskCtx.fill();
      });
      maskCtx.globalCompositeOperation = "source-over";
    }

    window.addEventListener("resize", () => {
      resizeCanvas();
      startAnimation();
    });

    function startAnimation() {
      cols = parseInt(document.getElementById("cols").value);
      rows = parseInt(document.getElementById("rows").value);
      baseDirection = document.getElementById("direction").value;
      direction = baseDirection;
      speed = parseFloat(document.getElementById("speed").value);
      invertInterval = parseInt(document.getElementById("invertTime").value) * 1000;
      lastInvertTime = Date.now();
      vrEnabled = document.getElementById("vrMode").checked;
      sphereEnabled = document.getElementById("sphereMode").checked;

      const spacingX = canvas.width / cols;
      const spacingY = canvas.height / rows;
      points = [];

      for (let i = 0; i < cols; i++) {
        for (let j = 0; j < rows; j++) {
          points.push({
            x: i * spacingX + spacingX / 2,
            y: j * spacingY + spacingY / 2
          });
        }
      }
      drawMask();
    }

    function invertDirection() {
      if (baseDirection === "right") direction = (direction === "right") ? "left" : "right";
      else if (baseDirection === "left") direction = (direction === "left") ? "right" : "left";
      else if (baseDirection === "up") direction = (direction === "up") ? "down" : "up";
      else if (baseDirection === "down") direction = (direction === "down") ? "up" : "down";
    }

    function update() {
      if (Date.now() - lastInvertTime > invertInterval) {
        invertDirection();
        lastInvertTime = Date.now();
      }

      for (let point of points) {
        if (direction === "right") point.x += speed;
        if (direction === "left") point.x -= speed;
        if (direction === "up") point.y -= speed;
        if (direction === "down") point.y += speed;

        if (point.x > canvas.width) point.x -= canvas.width;
        if (point.x < 0) point.x += canvas.width;
        if (point.y > canvas.height) point.y -= canvas.height;
        if (point.y < 0) point.y += canvas.height;
      }
    }

    function projectToSphere(x, y) {
      const cx = canvas.width / 2, cy = canvas.height / 2;
      const dx = (x - cx) / cx, dy = (y - cy) / cy;
      const r = Math.sqrt(dx * dx + dy * dy);
      const scale = Math.cos(r * Math.PI / 2);
      return { x: cx + dx * cx * scale, y: cy + dy * cy * scale };
    }

    function drawScene(offsetX = 0) {
      ctx.fillStyle = "white";
      for (let point of points) {
        for (let dx of [-canvas.width, 0, canvas.width]) {
          for (let dy of [-canvas.height, 0, canvas.height]) {
            let px = point.x + dx + offsetX;
            let py = point.y + dy;
            if (sphereEnabled) {
              const projected = projectToSphere(px, py);
              px = projected.x;
              py = projected.y;
            }
            ctx.beginPath();
            ctx.arc(px, py, 5, 0, Math.PI * 2);
            ctx.fill();
          }
        }
      }
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (vrEnabled) {
        ctx.save(); ctx.rect(0, 0, canvas.width / 2, canvas.height); ctx.clip();
        drawScene(0); ctx.restore();

        ctx.save(); ctx.rect(canvas.width / 2, 0, canvas.width / 2, canvas.height); ctx.clip();
        drawScene(-canvas.width / 2); ctx.restore();
      } else {
        drawScene(0);
      }
    }

    function animate() {
      if (!isPaused) {
        update();
        draw();
      }
      requestAnimationFrame(animate);
    }

    function togglePause() {
      isPaused = !isPaused;
    }

    resizeCanvas();
    startAnimation();
    animate();
  </script>
</body>
</html>
